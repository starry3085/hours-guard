<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工时卫士 - 调试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .debug-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .debug-item {
            margin: 5px 0;
            padding: 5px;
            background: #f9f9f9;
            border-radius: 3px;
        }

        .status-ok {
            color: #28a745;
        }

        .status-error {
            color: #dc3545;
        }

        .status-warning {
            color: #ffc107;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="debug-container">
        <h1>工时卫士 - 系统诊断</h1>

        <div class="debug-section">
            <div class="debug-title">基础功能检查</div>
            <div id="basicChecks"></div>
        </div>

        <div class="debug-section">
            <div class="debug-title">存储系统检查</div>
            <div id="storageChecks"></div>
        </div>

        <div class="debug-section">
            <div class="debug-title">Service Worker 状态</div>
            <div id="swStatus"></div>
        </div>

        <div class="debug-section">
            <div class="debug-title">错误日志</div>
            <div id="errorLogs"></div>
            <button onclick="clearErrorLogs()">清除错误日志</button>
            <button onclick="exportErrorLogs()">导出错误日志</button>
        </div>

        <div class="debug-section">
            <div class="debug-title">测试功能</div>
            <button onclick="testClockIn()">测试打卡功能</button>
            <button onclick="testStorage()">测试存储功能</button>
            <button onclick="runFullDiagnosis()">完整诊断</button>
            <div id="testResults"></div>
        </div>

        <div class="debug-section">
            <div class="debug-title">系统信息</div>
            <div id="systemInfo"></div>
        </div>
    </div>

    <script>
        // 调试工具
        class DebugTool {
            constructor() {
                this.init();
            }

            init() {
                this.runBasicChecks();
                this.checkStorage();
                this.checkServiceWorker();
                this.loadErrorLogs();
                this.getSystemInfo();
            }

            runBasicChecks() {
                const container = document.getElementById('basicChecks');
                const checks = [
                    { name: 'localStorage 支持', test: () => typeof Storage !== 'undefined' },
                    { name: 'JSON 支持', test: () => typeof JSON !== 'undefined' },
                    { name: 'Date 对象', test: () => typeof Date !== 'undefined' },
                    { name: 'Promise 支持', test: () => typeof Promise !== 'undefined' },
                    { name: 'Service Worker 支持', test: () => 'serviceWorker' in navigator },
                    { name: '网络连接', test: () => navigator.onLine }
                ];

                checks.forEach(check => {
                    const result = check.test();
                    const status = result ? 'status-ok' : 'status-error';
                    const icon = result ? '✓' : '✗';
                    container.innerHTML += `<div class="debug-item ${status}">${icon} ${check.name}: ${result ? '正常' : '异常'}</div>`;
                });
            }

            checkStorage() {
                const container = document.getElementById('storageChecks');

                try {
                    // 测试 localStorage 读写
                    const testKey = 'debug_test';
                    const testValue = 'test_value';
                    localStorage.setItem(testKey, testValue);
                    const retrieved = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);

                    const writeTest = retrieved === testValue;
                    container.innerHTML += `<div class="debug-item ${writeTest ? 'status-ok' : 'status-error'}">
                        ${writeTest ? '✓' : '✗'} localStorage 读写测试: ${writeTest ? '正常' : '失败'}
                    </div>`;

                    // 检查现有数据
                    const records = localStorage.getItem('hoursGuard_records');
                    const recordCount = records ? JSON.parse(records).length : 0;
                    container.innerHTML += `<div class="debug-item status-ok">✓ 现有记录数量: ${recordCount}</div>`;

                    // 检查存储使用量
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (key.startsWith('hoursGuard_')) {
                            totalSize += localStorage[key].length;
                        }
                    }
                    container.innerHTML += `<div class="debug-item status-ok">✓ 存储使用量: ${(totalSize / 1024).toFixed(2)} KB</div>`;

                } catch (error) {
                    container.innerHTML += `<div class="debug-item status-error">✗ 存储系统错误: ${error.message}</div>`;
                }
            }

            async checkServiceWorker() {
                const container = document.getElementById('swStatus');
                
                // 检查环境支持
                const isHttps = location.protocol === 'https:';
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                const isFileProtocol = location.protocol === 'file:';
                
                container.innerHTML += `<div class="debug-item">当前协议: ${location.protocol}</div>`;
                container.innerHTML += `<div class="debug-item">当前域名: ${location.hostname}</div>`;
                
                if (isFileProtocol) {
                    container.innerHTML += `<div class="debug-item status-warning">⚠ 检测到 file:// 协议，Service Worker 不可用</div>`;
                    container.innerHTML += `<div class="debug-item status-warning">⚠ 建议使用 HTTP 服务器访问应用</div>`;
                    container.innerHTML += `<div class="debug-item">💡 应用仍可正常使用，只是没有离线功能</div>`;
                    return;
                }
                
                if (!isHttps && !isLocalhost) {
                    container.innerHTML += `<div class="debug-item status-warning">⚠ 非 HTTPS 环境，Service Worker 可能不可用</div>`;
                }

                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.getRegistration();
                        if (registration) {
                            container.innerHTML += `<div class="debug-item status-ok">✓ Service Worker 已注册</div>`;
                            container.innerHTML += `<div class="debug-item status-ok">✓ 作用域: ${registration.scope}</div>`;

                            if (registration.active) {
                                container.innerHTML += `<div class="debug-item status-ok">✓ Service Worker 状态: 活跃</div>`;
                            } else {
                                container.innerHTML += `<div class="debug-item status-warning">⚠ Service Worker 状态: 未激活</div>`;
                            }
                        } else {
                            container.innerHTML += `<div class="debug-item status-warning">⚠ Service Worker 未注册</div>`;
                            if (isHttps || isLocalhost) {
                                container.innerHTML += `<div class="debug-item">环境支持 Service Worker，但未注册成功</div>`;
                            }
                        }
                    } catch (error) {
                        container.innerHTML += `<div class="debug-item status-error">✗ Service Worker 错误: ${error.message}</div>`;
                        container.innerHTML += `<div class="debug-item">💡 这不会影响应用的基本功能</div>`;
                    }
                } else {
                    container.innerHTML += `<div class="debug-item status-error">✗ 浏览器不支持 Service Worker</div>`;
                }
            }

            loadErrorLogs() {
                const container = document.getElementById('errorLogs');

                try {
                    const logs = JSON.parse(localStorage.getItem('hoursGuard_errorLog') || '[]');
                    if (logs.length === 0) {
                        container.innerHTML = '<div class="debug-item status-ok">✓ 暂无错误日志</div>';
                    } else {
                        container.innerHTML = `<div class="debug-item status-warning">⚠ 发现 ${logs.length} 条错误日志</div>`;
                        const recentLogs = logs.slice(-5); // 显示最近5条
                        recentLogs.forEach(log => {
                            container.innerHTML += `<pre>${JSON.stringify(log, null, 2)}</pre>`;
                        });
                    }
                } catch (error) {
                    container.innerHTML = `<div class="debug-item status-error">✗ 无法读取错误日志: ${error.message}</div>`;
                }
            }

            getSystemInfo() {
                const container = document.getElementById('systemInfo');
                const info = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    screen: `${screen.width}x${screen.height}`,
                    viewport: `${window.innerWidth}x${window.innerHeight}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    currentTime: new Date().toLocaleString('zh-CN')
                };

                Object.entries(info).forEach(([key, value]) => {
                    container.innerHTML += `<div class="debug-item">${key}: ${value}</div>`;
                });
            }
        }

        // 测试函数
        function testClockIn() {
            const container = document.getElementById('testResults');
            container.innerHTML = '<div class="debug-item">正在测试打卡功能...</div>';

            try {
                // 模拟打卡
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const dateStr = now.toISOString().split('T')[0];

                // 获取现有记录
                const records = JSON.parse(localStorage.getItem('hoursGuard_records') || '[]');

                // 添加测试记录
                const testRecord = {
                    date: dateStr,
                    on: timeStr,
                    test: true
                };

                records.push(testRecord);
                localStorage.setItem('hoursGuard_records', JSON.stringify(records));

                container.innerHTML += '<div class="debug-item status-ok">✓ 打卡功能测试成功</div>';
                container.innerHTML += `<div class="debug-item">测试记录: ${dateStr} ${timeStr}</div>`;

                // 清理测试记录
                setTimeout(() => {
                    const updatedRecords = JSON.parse(localStorage.getItem('hoursGuard_records') || '[]');
                    const cleanedRecords = updatedRecords.filter(r => !r.test);
                    localStorage.setItem('hoursGuard_records', JSON.stringify(cleanedRecords));
                    container.innerHTML += '<div class="debug-item">✓ 测试记录已清理</div>';
                }, 2000);

            } catch (error) {
                container.innerHTML += `<div class="debug-item status-error">✗ 打卡功能测试失败: ${error.message}</div>`;
            }
        }

        function testStorage() {
            const container = document.getElementById('testResults');
            container.innerHTML = '<div class="debug-item">正在测试存储功能...</div>';

            try {
                // 测试大量数据写入
                const testData = [];
                for (let i = 0; i < 100; i++) {
                    testData.push({
                        id: i,
                        date: new Date(Date.now() - i * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        on: '09:00',
                        off: '18:00'
                    });
                }

                const testKey = 'hoursGuard_test_data';
                localStorage.setItem(testKey, JSON.stringify(testData));

                const retrieved = JSON.parse(localStorage.getItem(testKey));
                const success = retrieved.length === testData.length;

                localStorage.removeItem(testKey);

                container.innerHTML += `<div class="debug-item ${success ? 'status-ok' : 'status-error'}">
                    ${success ? '✓' : '✗'} 大量数据存储测试: ${success ? '成功' : '失败'}
                </div>`;

            } catch (error) {
                container.innerHTML += `<div class="debug-item status-error">✗ 存储功能测试失败: ${error.message}</div>`;
            }
        }

        function runFullDiagnosis() {
            const container = document.getElementById('testResults');
            container.innerHTML = '<div class="debug-item">正在运行完整诊断...</div>';

            // 重新运行所有检查
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        function clearErrorLogs() {
            try {
                localStorage.removeItem('hoursGuard_errorLog');
                document.getElementById('errorLogs').innerHTML = '<div class="debug-item status-ok">✓ 错误日志已清除</div>';
            } catch (error) {
                document.getElementById('errorLogs').innerHTML += `<div class="debug-item status-error">✗ 清除失败: ${error.message}</div>`;
            }
        }

        function exportErrorLogs() {
            try {
                const logs = localStorage.getItem('hoursGuard_errorLog') || '[]';
                const blob = new Blob([logs], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `hours-guard-error-logs-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                document.getElementById('errorLogs').innerHTML += '<div class="debug-item status-ok">✓ 错误日志已导出</div>';
            } catch (error) {
                document.getElementById('errorLogs').innerHTML += `<div class="debug-item status-error">✗ 导出失败: ${error.message}</div>`;
            }
        }

        // 初始化调试工具
        window.addEventListener('load', () => {
            new DebugTool();
        });
    </script>
</body>

</html>