<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ—¶å«å£« - è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .debug-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .debug-item {
            margin: 5px 0;
            padding: 5px;
            background: #f9f9f9;
            border-radius: 3px;
        }

        .status-ok {
            color: #28a745;
        }

        .status-error {
            color: #dc3545;
        }

        .status-warning {
            color: #ffc107;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="debug-container">
        <h1>å·¥æ—¶å«å£« - ç³»ç»Ÿè¯Šæ–­</h1>

        <div class="debug-section">
            <div class="debug-title">åŸºç¡€åŠŸèƒ½æ£€æŸ¥</div>
            <div id="basicChecks"></div>
        </div>

        <div class="debug-section">
            <div class="debug-title">å­˜å‚¨ç³»ç»Ÿæ£€æŸ¥</div>
            <div id="storageChecks"></div>
        </div>

        <div class="debug-section">
            <div class="debug-title">Service Worker çŠ¶æ€</div>
            <div id="swStatus"></div>
        </div>

        <div class="debug-section">
            <div class="debug-title">é”™è¯¯æ—¥å¿—</div>
            <div id="errorLogs"></div>
            <button onclick="clearErrorLogs()">æ¸…é™¤é”™è¯¯æ—¥å¿—</button>
            <button onclick="exportErrorLogs()">å¯¼å‡ºé”™è¯¯æ—¥å¿—</button>
        </div>

        <div class="debug-section">
            <div class="debug-title">æµ‹è¯•åŠŸèƒ½</div>
            <button onclick="testClockIn()">æµ‹è¯•æ‰“å¡åŠŸèƒ½</button>
            <button onclick="testStorage()">æµ‹è¯•å­˜å‚¨åŠŸèƒ½</button>
            <button onclick="runFullDiagnosis()">å®Œæ•´è¯Šæ–­</button>
            <div id="testResults"></div>
        </div>

        <div class="debug-section">
            <div class="debug-title">ç³»ç»Ÿä¿¡æ¯</div>
            <div id="systemInfo"></div>
        </div>
    </div>

    <script>
        // è°ƒè¯•å·¥å…·
        class DebugTool {
            constructor() {
                this.init();
            }

            init() {
                this.runBasicChecks();
                this.checkStorage();
                this.checkServiceWorker();
                this.loadErrorLogs();
                this.getSystemInfo();
            }

            runBasicChecks() {
                const container = document.getElementById('basicChecks');
                const checks = [
                    { name: 'localStorage æ”¯æŒ', test: () => typeof Storage !== 'undefined' },
                    { name: 'JSON æ”¯æŒ', test: () => typeof JSON !== 'undefined' },
                    { name: 'Date å¯¹è±¡', test: () => typeof Date !== 'undefined' },
                    { name: 'Promise æ”¯æŒ', test: () => typeof Promise !== 'undefined' },
                    { name: 'Service Worker æ”¯æŒ', test: () => 'serviceWorker' in navigator },
                    { name: 'ç½‘ç»œè¿æ¥', test: () => navigator.onLine }
                ];

                checks.forEach(check => {
                    const result = check.test();
                    const status = result ? 'status-ok' : 'status-error';
                    const icon = result ? 'âœ“' : 'âœ—';
                    container.innerHTML += `<div class="debug-item ${status}">${icon} ${check.name}: ${result ? 'æ­£å¸¸' : 'å¼‚å¸¸'}</div>`;
                });
            }

            checkStorage() {
                const container = document.getElementById('storageChecks');

                try {
                    // æµ‹è¯• localStorage è¯»å†™
                    const testKey = 'debug_test';
                    const testValue = 'test_value';
                    localStorage.setItem(testKey, testValue);
                    const retrieved = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);

                    const writeTest = retrieved === testValue;
                    container.innerHTML += `<div class="debug-item ${writeTest ? 'status-ok' : 'status-error'}">
                        ${writeTest ? 'âœ“' : 'âœ—'} localStorage è¯»å†™æµ‹è¯•: ${writeTest ? 'æ­£å¸¸' : 'å¤±è´¥'}
                    </div>`;

                    // æ£€æŸ¥ç°æœ‰æ•°æ®
                    const records = localStorage.getItem('hoursGuard_records');
                    const recordCount = records ? JSON.parse(records).length : 0;
                    container.innerHTML += `<div class="debug-item status-ok">âœ“ ç°æœ‰è®°å½•æ•°é‡: ${recordCount}</div>`;

                    // æ£€æŸ¥å­˜å‚¨ä½¿ç”¨é‡
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (key.startsWith('hoursGuard_')) {
                            totalSize += localStorage[key].length;
                        }
                    }
                    container.innerHTML += `<div class="debug-item status-ok">âœ“ å­˜å‚¨ä½¿ç”¨é‡: ${(totalSize / 1024).toFixed(2)} KB</div>`;

                } catch (error) {
                    container.innerHTML += `<div class="debug-item status-error">âœ— å­˜å‚¨ç³»ç»Ÿé”™è¯¯: ${error.message}</div>`;
                }
            }

            async checkServiceWorker() {
                const container = document.getElementById('swStatus');
                
                // æ£€æŸ¥ç¯å¢ƒæ”¯æŒ
                const isHttps = location.protocol === 'https:';
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                const isFileProtocol = location.protocol === 'file:';
                
                container.innerHTML += `<div class="debug-item">å½“å‰åè®®: ${location.protocol}</div>`;
                container.innerHTML += `<div class="debug-item">å½“å‰åŸŸå: ${location.hostname}</div>`;
                
                if (isFileProtocol) {
                    container.innerHTML += `<div class="debug-item status-warning">âš  æ£€æµ‹åˆ° file:// åè®®ï¼ŒService Worker ä¸å¯ç”¨</div>`;
                    container.innerHTML += `<div class="debug-item status-warning">âš  å»ºè®®ä½¿ç”¨ HTTP æœåŠ¡å™¨è®¿é—®åº”ç”¨</div>`;
                    container.innerHTML += `<div class="debug-item">ğŸ’¡ åº”ç”¨ä»å¯æ­£å¸¸ä½¿ç”¨ï¼Œåªæ˜¯æ²¡æœ‰ç¦»çº¿åŠŸèƒ½</div>`;
                    return;
                }
                
                if (!isHttps && !isLocalhost) {
                    container.innerHTML += `<div class="debug-item status-warning">âš  é HTTPS ç¯å¢ƒï¼ŒService Worker å¯èƒ½ä¸å¯ç”¨</div>`;
                }

                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.getRegistration();
                        if (registration) {
                            container.innerHTML += `<div class="debug-item status-ok">âœ“ Service Worker å·²æ³¨å†Œ</div>`;
                            container.innerHTML += `<div class="debug-item status-ok">âœ“ ä½œç”¨åŸŸ: ${registration.scope}</div>`;

                            if (registration.active) {
                                container.innerHTML += `<div class="debug-item status-ok">âœ“ Service Worker çŠ¶æ€: æ´»è·ƒ</div>`;
                            } else {
                                container.innerHTML += `<div class="debug-item status-warning">âš  Service Worker çŠ¶æ€: æœªæ¿€æ´»</div>`;
                            }
                        } else {
                            container.innerHTML += `<div class="debug-item status-warning">âš  Service Worker æœªæ³¨å†Œ</div>`;
                            if (isHttps || isLocalhost) {
                                container.innerHTML += `<div class="debug-item">ç¯å¢ƒæ”¯æŒ Service Workerï¼Œä½†æœªæ³¨å†ŒæˆåŠŸ</div>`;
                            }
                        }
                    } catch (error) {
                        container.innerHTML += `<div class="debug-item status-error">âœ— Service Worker é”™è¯¯: ${error.message}</div>`;
                        container.innerHTML += `<div class="debug-item">ğŸ’¡ è¿™ä¸ä¼šå½±å“åº”ç”¨çš„åŸºæœ¬åŠŸèƒ½</div>`;
                    }
                } else {
                    container.innerHTML += `<div class="debug-item status-error">âœ— æµè§ˆå™¨ä¸æ”¯æŒ Service Worker</div>`;
                }
            }

            loadErrorLogs() {
                const container = document.getElementById('errorLogs');

                try {
                    const logs = JSON.parse(localStorage.getItem('hoursGuard_errorLog') || '[]');
                    if (logs.length === 0) {
                        container.innerHTML = '<div class="debug-item status-ok">âœ“ æš‚æ— é”™è¯¯æ—¥å¿—</div>';
                    } else {
                        container.innerHTML = `<div class="debug-item status-warning">âš  å‘ç° ${logs.length} æ¡é”™è¯¯æ—¥å¿—</div>`;
                        const recentLogs = logs.slice(-5); // æ˜¾ç¤ºæœ€è¿‘5æ¡
                        recentLogs.forEach(log => {
                            container.innerHTML += `<pre>${JSON.stringify(log, null, 2)}</pre>`;
                        });
                    }
                } catch (error) {
                    container.innerHTML = `<div class="debug-item status-error">âœ— æ— æ³•è¯»å–é”™è¯¯æ—¥å¿—: ${error.message}</div>`;
                }
            }

            getSystemInfo() {
                const container = document.getElementById('systemInfo');
                const info = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    screen: `${screen.width}x${screen.height}`,
                    viewport: `${window.innerWidth}x${window.innerHeight}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    currentTime: new Date().toLocaleString('zh-CN')
                };

                Object.entries(info).forEach(([key, value]) => {
                    container.innerHTML += `<div class="debug-item">${key}: ${value}</div>`;
                });
            }
        }

        // æµ‹è¯•å‡½æ•°
        function testClockIn() {
            const container = document.getElementById('testResults');
            container.innerHTML = '<div class="debug-item">æ­£åœ¨æµ‹è¯•æ‰“å¡åŠŸèƒ½...</div>';

            try {
                // æ¨¡æ‹Ÿæ‰“å¡
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const dateStr = now.toISOString().split('T')[0];

                // è·å–ç°æœ‰è®°å½•
                const records = JSON.parse(localStorage.getItem('hoursGuard_records') || '[]');

                // æ·»åŠ æµ‹è¯•è®°å½•
                const testRecord = {
                    date: dateStr,
                    on: timeStr,
                    test: true
                };

                records.push(testRecord);
                localStorage.setItem('hoursGuard_records', JSON.stringify(records));

                container.innerHTML += '<div class="debug-item status-ok">âœ“ æ‰“å¡åŠŸèƒ½æµ‹è¯•æˆåŠŸ</div>';
                container.innerHTML += `<div class="debug-item">æµ‹è¯•è®°å½•: ${dateStr} ${timeStr}</div>`;

                // æ¸…ç†æµ‹è¯•è®°å½•
                setTimeout(() => {
                    const updatedRecords = JSON.parse(localStorage.getItem('hoursGuard_records') || '[]');
                    const cleanedRecords = updatedRecords.filter(r => !r.test);
                    localStorage.setItem('hoursGuard_records', JSON.stringify(cleanedRecords));
                    container.innerHTML += '<div class="debug-item">âœ“ æµ‹è¯•è®°å½•å·²æ¸…ç†</div>';
                }, 2000);

            } catch (error) {
                container.innerHTML += `<div class="debug-item status-error">âœ— æ‰“å¡åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        function testStorage() {
            const container = document.getElementById('testResults');
            container.innerHTML = '<div class="debug-item">æ­£åœ¨æµ‹è¯•å­˜å‚¨åŠŸèƒ½...</div>';

            try {
                // æµ‹è¯•å¤§é‡æ•°æ®å†™å…¥
                const testData = [];
                for (let i = 0; i < 100; i++) {
                    testData.push({
                        id: i,
                        date: new Date(Date.now() - i * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        on: '09:00',
                        off: '18:00'
                    });
                }

                const testKey = 'hoursGuard_test_data';
                localStorage.setItem(testKey, JSON.stringify(testData));

                const retrieved = JSON.parse(localStorage.getItem(testKey));
                const success = retrieved.length === testData.length;

                localStorage.removeItem(testKey);

                container.innerHTML += `<div class="debug-item ${success ? 'status-ok' : 'status-error'}">
                    ${success ? 'âœ“' : 'âœ—'} å¤§é‡æ•°æ®å­˜å‚¨æµ‹è¯•: ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}
                </div>`;

            } catch (error) {
                container.innerHTML += `<div class="debug-item status-error">âœ— å­˜å‚¨åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        function runFullDiagnosis() {
            const container = document.getElementById('testResults');
            container.innerHTML = '<div class="debug-item">æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...</div>';

            // é‡æ–°è¿è¡Œæ‰€æœ‰æ£€æŸ¥
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        function clearErrorLogs() {
            try {
                localStorage.removeItem('hoursGuard_errorLog');
                document.getElementById('errorLogs').innerHTML = '<div class="debug-item status-ok">âœ“ é”™è¯¯æ—¥å¿—å·²æ¸…é™¤</div>';
            } catch (error) {
                document.getElementById('errorLogs').innerHTML += `<div class="debug-item status-error">âœ— æ¸…é™¤å¤±è´¥: ${error.message}</div>`;
            }
        }

        function exportErrorLogs() {
            try {
                const logs = localStorage.getItem('hoursGuard_errorLog') || '[]';
                const blob = new Blob([logs], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `hours-guard-error-logs-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                document.getElementById('errorLogs').innerHTML += '<div class="debug-item status-ok">âœ“ é”™è¯¯æ—¥å¿—å·²å¯¼å‡º</div>';
            } catch (error) {
                document.getElementById('errorLogs').innerHTML += `<div class="debug-item status-error">âœ— å¯¼å‡ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        // åˆå§‹åŒ–è°ƒè¯•å·¥å…·
        window.addEventListener('load', () => {
            new DebugTool();
        });
    </script>
</body>

</html>